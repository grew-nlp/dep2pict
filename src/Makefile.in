include ../config/Makefile

LOG = -DDEBUG=\"@DEBUG@\" -DINFO=\"@INFO@\" -DMESSAGE=\"@MESSAGE@\" -DWARNING=\"@WARNING@\"

opt_gtk : dep2pict_glade.ml dep2pict_glade.cmx gui.cmx main.cmx ../bin/dep2pict.opt

opt : main.cmx ../bin/dep2pict.opt

dep2pict_glade.ml : dep2pict.glade
	@echo "  ----> build file 'dep2pict_glade.ml' from 'dep2pict.glade'"
	lablgladecc2 dep2pict.glade > dep2pict_glade.ml
	@echo "  ----> set absolute file location in 'dep2pict_glade.ml' (DATA_DIR = $(DATA_DIR))"
	sed -i back 's|dep2pict.glade|$(DATA_DIR)dep2pict.glade|g' dep2pict_glade.ml
	rm -f dep2pict_glade.mlback

# dep2pict_glade.ml : dep2pict.glade
# 	sed 's/<property name="invisible_char">&#x25CF;<\/property>//g' dep2pict.glade > glade.tmp
# 	mv glade.tmp dep2pict.glade.ml
# 	lablgladecc2 dep2pict.glade.ml > dep2pict_glade.ml
# 	rm dep2pict.glade.ml
# 	sed 's|dep2pict.glade.ml|$(DATA_DIR)dep2pict.glade|g' dep2pict_glade.ml > dep2pict_glade.tmp
#	mv dep2pict_glade.tmp dep2pict_glade.ml


dep2pict_glade.cmx : dep2pict_glade.ml
	$(OCAMLOPT) -c $(LABLGTK_OPT) $(CAIRO_OPT) dep2pict_glade.ml

DEP_OPT= unix.cmxa str.cmxa bigarray.cmxa $(LABLGTK_OPT) $(CAIRO_OPT) $(XML_LIGHT_OPT) $(ANSITERMINAL_OPT) $(LOG_OPT) $(DEP2PICT_OPT) 
DEP_OPT_NOGUI= unix.cmxa str.cmxa bigarray.cmxa $(CAIRO_OPT) $(XML_LIGHT_OPT) $(ANSITERMINAL_OPT) $(LOG_OPT) $(DEP2PICT_OPT) 

global.cmx : global.ml
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo -DBUILD_GUI -DDATA_DIR=\"$(DATA_DIR)\" $(LOG) -DVERSION=\"$(VERSION)\"' $(DEP_OPT) global.ml

gui.cmx : gui.ml global.cmx dep2pict_glade.cmx 
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo -DBUILD_GUI -DDATA_DIR=\"$(DATA_DIR)\" $(LOG) -DVERSION=\"$(VERSION)\"' $(DEP_OPT) dep2pict_glade.cmx gui.ml

main.cmx : main.ml global.cmx
ifeq (@BUILD_GUI@,yes)
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo -DBUILD_GUI -DDATA_DIR=\"$(DATA_DIR)\" $(LOG) -DVERSION=\"$(VERSION)\"' $(DEP_OPT) dep2pict_glade.cmx global.cmx gui.cmx main.ml
else
	$(OCAMLOPT) -c -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\" $(LOG) -DVERSION=\"$(VERSION)\"' $(DEP_OPT) global.cmx main.ml
endif


../bin/dep2pict.opt : main.cmx
	mkdir -p ../bin
ifeq (@BUILD_GUI@,yes)
	$(OCAMLOPT) -o ../bin/dep2pict.opt -pp 'camlp4o pa_macro.cmo -DBUILD_GUI -DDATA_DIR=\"$(DATA_DIR)\" $(LOG) -DVERSION=\"$(VERSION)\"' $(DEP_OPT) dep2pict_glade.cmx global.cmx gui.cmx main.cmx
else
	$(OCAMLOPT) -o ../bin/dep2pict.opt -pp 'camlp4o pa_macro.cmo -DDATA_DIR=\"$(DATA_DIR)\" $(LOG) -DVERSION=\"$(VERSION)\"' $(DEP_OPT_NOGUI) global.cmx main.cmx
endif
